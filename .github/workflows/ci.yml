name: ðŸš€ Sleep Mode CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18.19'
  RUBY_VERSION: '3.1'
  FLUTTER_VERSION: '3.22.0'

jobs:
  # ðŸ“Š Quality Checks and Linting
  quality-checks:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ·ï¸ Generate build metadata
        id: meta
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "ref=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT

      # Frontend Quality Checks
      - name: ðŸ“¦ Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sleep_mode_frontend/package-lock.json

      - name: ðŸ“¥ Install Frontend Dependencies
        working-directory: sleep_mode_frontend
        run: npm ci

      - name: ðŸ” Frontend ESLint
        working-directory: sleep_mode_frontend
        run: npm run lint

      - name: ðŸ” Frontend TypeScript Check
        working-directory: sleep_mode_frontend
        run: npm run type-check

      # Backend Quality Checks
      - name: ðŸ’Ž Setup Ruby for Backend
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: sleep_mode_rails

      - name: ðŸ” Backend RuboCop
        working-directory: sleep_mode_rails
        run: bundle exec rubocop --format github

      # Flutter Quality Checks
      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¥ Flutter Dependencies
        working-directory: sleep_mode_flutter
        run: flutter pub get

      - name: ðŸ” Flutter Analyze
        working-directory: sleep_mode_flutter
        run: flutter analyze

      - name: ðŸ” Flutter Format Check
        working-directory: sleep_mode_flutter
        run: flutter format --set-exit-if-changed .

  # ðŸ§ª Backend Tests (Rails API)
  backend-tests:
    name: ðŸ§ª Backend Tests (Rails)
    runs-on: ubuntu-latest
    needs: quality-checks
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: sleep_mode_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      RAILS_ENV: test
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/sleep_mode_test
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: sleep_mode_rails

      - name: ðŸ—„ï¸ Setup Database
        working-directory: sleep_mode_rails
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: ðŸ§ª Run Backend Tests with Coverage
        working-directory: sleep_mode_rails
        run: |
          bundle exec rspec \
            --format progress \
            --format RspecJunitFormatter \
            --out tmp/rspec.xml \
            --format json \
            --out tmp/rspec.json

      - name: ðŸ“Š Upload Backend Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./sleep_mode_rails/coverage/lcov.info
          flags: backend
          name: backend-coverage

      - name: ðŸ“„ Upload Backend Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: |
            sleep_mode_rails/tmp/rspec.xml
            sleep_mode_rails/tmp/rspec.json
            sleep_mode_rails/coverage/

  # âš›ï¸ Frontend Tests (React)
  frontend-tests:
    name: âš›ï¸ Frontend Tests (React)
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sleep_mode_frontend/package-lock.json

      - name: ðŸ“¥ Install Dependencies
        working-directory: sleep_mode_frontend
        run: npm ci

      - name: ðŸ§ª Run Unit Tests with Coverage
        working-directory: sleep_mode_frontend
        run: npm run ci:coverage

      - name: ðŸ“Š Generate Coverage Badges
        working-directory: sleep_mode_frontend
        run: npm run coverage:badges

      - name: ðŸ“Š Upload Frontend Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./sleep_mode_frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

      - name: ðŸ“„ Upload Frontend Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: |
            sleep_mode_frontend/test-results/
            sleep_mode_frontend/coverage/

  # ðŸŽ­ E2E Tests (Playwright)
  e2e-tests:
    name: ðŸŽ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: sleep_mode_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/sleep_mode_test
      RAILS_ENV: test
      NODE_ENV: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Setup Backend for E2E
      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: sleep_mode_rails

      - name: ðŸ—„ï¸ Setup Test Database
        working-directory: sleep_mode_rails
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load
          bundle exec rails db:seed

      # Setup Frontend for E2E
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sleep_mode_frontend/package-lock.json

      - name: ðŸ“¥ Install Frontend Dependencies
        working-directory: sleep_mode_frontend
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        working-directory: sleep_mode_frontend
        run: npx playwright install --with-deps

      - name: ðŸš€ Start Backend Server
        working-directory: sleep_mode_rails
        run: |
          bundle exec rails server -p 3000 &
          sleep 10
          curl -f http://localhost:3000/health || exit 1

      - name: ðŸš€ Build and Start Frontend
        working-directory: sleep_mode_frontend
        run: |
          npm run build
          npm run preview &
          sleep 10
          curl -f http://localhost:4173 || exit 1

      - name: ðŸŽ­ Run E2E Tests
        working-directory: sleep_mode_frontend
        run: npm run ci:e2e

      - name: ðŸ“„ Upload E2E Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            sleep_mode_frontend/test-results/
            sleep_mode_frontend/playwright-report/

  # ðŸ“± Flutter Tests
  flutter-tests:
    name: ðŸ“± Flutter Tests (Mobile)
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¥ Install Dependencies
        working-directory: sleep_mode_flutter
        run: flutter pub get

      - name: ðŸ§ª Run Flutter Tests
        working-directory: sleep_mode_flutter
        run: flutter test --coverage --reporter json > test-results.json

      - name: ðŸ“Š Upload Flutter Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./sleep_mode_flutter/coverage/lcov.info
          flags: flutter
          name: flutter-coverage

      - name: ðŸ“„ Upload Flutter Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: flutter-test-results
          path: |
            sleep_mode_flutter/test-results.json
            sleep_mode_flutter/coverage/

  # ðŸ—ï¸ Build Verification
  build-verification:
    name: ðŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, flutter-tests]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        platform: [web, android, ios]
        include:
          - platform: web
            build_command: "cd sleep_mode_frontend && npm run build"
          - platform: android
            build_command: "cd sleep_mode_flutter && flutter build apk --debug"
          - platform: ios
            build_command: "cd sleep_mode_flutter && flutter build ios --debug --no-codesign"

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js (Web)
        if: matrix.platform == 'web'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sleep_mode_frontend/package-lock.json

      - name: ðŸ“± Setup Flutter (Mobile)
        if: matrix.platform != 'web'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¥ Install Dependencies
        run: |
          if [ "${{ matrix.platform }}" = "web" ]; then
            cd sleep_mode_frontend && npm ci
          else
            cd sleep_mode_flutter && flutter pub get
          fi

      - name: ðŸ—ï¸ Build ${{ matrix.platform }}
        run: ${{ matrix.build_command }}

      - name: ðŸ“„ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}
          path: |
            sleep_mode_frontend/dist/
            sleep_mode_flutter/build/

  # ðŸš€ Deployment
  deploy:
    name: ðŸš€ Deploy to ${{ github.event.inputs.deploy_environment || 'staging' }}
    runs-on: ubuntu-latest
    needs: [e2e-tests, build-verification]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch')
    
    environment: 
      name: ${{ github.event.inputs.deploy_environment || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: ./builds
          merge-multiple: true

      - name: ðŸš€ Deploy Application
        id: deploy
        run: |
          echo "Deploying to ${{ github.event.inputs.deploy_environment || 'staging' }}"
          echo "url=https://sleepmode-${{ github.event.inputs.deploy_environment || 'staging' }}.example.com" >> $GITHUB_OUTPUT
          # Add actual deployment steps here

  # ðŸ“Š Test Results Summary
  test-summary:
    name: ðŸ“Š Test Results Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, flutter-tests, e2e-tests]
    if: always()

    steps:
      - name: ðŸ“¥ Download All Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: "*-test-results"
          path: ./test-results
          merge-multiple: true

      - name: ðŸ“Š Generate Test Summary
        run: |
          echo "# ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          
          # Backend Results
          if [ "${{ needs.backend-tests.result }}" = "success" ]; then
            echo "| ðŸ§ª Backend (Rails) | âœ… Passed | ðŸ“Š View Coverage |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª Backend (Rails) | âŒ Failed | ðŸ“Š View Coverage |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Frontend Results
          if [ "${{ needs.frontend-tests.result }}" = "success" ]; then
            echo "| âš›ï¸ Frontend (React) | âœ… Passed | ðŸ“Š View Coverage |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âš›ï¸ Frontend (React) | âŒ Failed | ðŸ“Š View Coverage |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Flutter Results
          if [ "${{ needs.flutter-tests.result }}" = "success" ]; then
            echo "| ðŸ“± Flutter (Mobile) | âœ… Passed | ðŸ“Š View Coverage |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“± Flutter (Mobile) | âŒ Failed | ðŸ“Š View Coverage |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # E2E Results
          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "| ðŸŽ­ E2E (Playwright) | âœ… Passed | ðŸ“„ View Report |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŽ­ E2E (Playwright) | âŒ Failed | ðŸ“„ View Report |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Coverage Reports**: Available in job artifacts" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ­ **E2E Report**: Available in Playwright artifacts" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ **Build Status**: ${{ needs.build-verification.result }}" >> $GITHUB_STEP_SUMMARY 